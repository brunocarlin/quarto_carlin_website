<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Bruno Testaguzza Carlin">
<meta name="dcterms.date" content="2023-03-31">
<title>Functional Auto Encoder with R Keras – Bruno Testaguzza Carlin</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-V18SLYYHQJ"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-V18SLYYHQJ', { 'anonymize_ip': true});
</script><link href="../../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<meta property="og:title" content="Functional Auto Encoder with R Keras – Bruno Testaguzza Carlin">
<meta property="og:description" content="The Site of Bruno Testaguzza Carlin">
<meta property="og:image" content="https://quartopub.com/sites/carlin/bruno-testaguzza-carlin/posts/new/autoencoder/autoencoder.png">
<meta property="og:site_name" content="Bruno Testaguzza Carlin">
<meta property="og:image:height" content="1364">
<meta property="og:image:width" content="1950">
<meta name="twitter:title" content="Functional Auto Encoder with R Keras – Bruno Testaguzza Carlin">
<meta name="twitter:description" content="The Site of Bruno Testaguzza Carlin">
<meta name="twitter:image" content="https://quartopub.com/sites/carlin/bruno-testaguzza-carlin/posts/new/autoencoder/autoencoder.png">
<meta name="twitter:creator" content="@BrunoTestaguzza">
<meta name="twitter:site" content="@brunocarlin">
<meta name="twitter:image-height" content="1364">
<meta name="twitter:image-width" content="1950">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Bruno Testaguzza Carlin</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Welcome to my site</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/brunocarlin/quarto_carlin_website"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/bruno-carlin/"> <i class="bi bi-linkedin" role="img" aria-label="LinkedIn">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/BrunoTestaguzza"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#objective" id="toc-objective" class="nav-link active" data-scroll-target="#objective">Objective</a></li>
  <li><a href="#libraries" id="toc-libraries" class="nav-link" data-scroll-target="#libraries">Libraries</a></li>
  <li><a href="#download-the-dataset" id="toc-download-the-dataset" class="nav-link" data-scroll-target="#download-the-dataset">Download The Dataset</a></li>
  <li>
<a href="#preprocessing" id="toc-preprocessing" class="nav-link" data-scroll-target="#preprocessing">Preprocessing</a>
  <ul class="collapse">
<li><a href="#split-the-data" id="toc-split-the-data" class="nav-link" data-scroll-target="#split-the-data">Split the data</a></li>
  <li><a href="#normalize-the-data-to-01." id="toc-normalize-the-data-to-01." class="nav-link" data-scroll-target="#normalize-the-data-to-01.">Normalize the data to [0,1].</a></li>
  <li><a href="#separate-datasets-for-future-usage" id="toc-separate-datasets-for-future-usage" class="nav-link" data-scroll-target="#separate-datasets-for-future-usage">Separate datasets for future usage</a></li>
  </ul>
</li>
  <li>
<a href="#see-the-data" id="toc-see-the-data" class="nav-link" data-scroll-target="#see-the-data">See the data</a>
  <ul class="collapse">
<li><a href="#normal-ecg" id="toc-normal-ecg" class="nav-link" data-scroll-target="#normal-ecg">Normal ECG</a></li>
  <li><a href="#anomalous-ecg" id="toc-anomalous-ecg" class="nav-link" data-scroll-target="#anomalous-ecg">Anomalous ECG</a></li>
  </ul>
</li>
  <li><a href="#create-matrixes-for-tensorflow" id="toc-create-matrixes-for-tensorflow" class="nav-link" data-scroll-target="#create-matrixes-for-tensorflow">Create Matrixes for tensorflow</a></li>
  <li>
<a href="#build-the-auto-encoder--using-the-functional-api" id="toc-build-the-auto-encoder--using-the-functional-api" class="nav-link" data-scroll-target="#build-the-auto-encoder--using-the-functional-api">Build The Auto Encoder- Using the functional api</a>
  <ul class="collapse">
<li><a href="#discover-the-input-and-output-dimensions" id="toc-discover-the-input-and-output-dimensions" class="nav-link" data-scroll-target="#discover-the-input-and-output-dimensions">Discover the input and output dimensions</a></li>
  <li><a href="#define-the-encoder" id="toc-define-the-encoder" class="nav-link" data-scroll-target="#define-the-encoder">Define the encoder</a></li>
  <li><a href="#define-decoder" id="toc-define-decoder" class="nav-link" data-scroll-target="#define-decoder">Define Decoder</a></li>
  <li><a href="#define-the-auto-encoder" id="toc-define-the-auto-encoder" class="nav-link" data-scroll-target="#define-the-auto-encoder">Define The Auto Encoder</a></li>
  <li><a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model">Fit the model</a></li>
  </ul>
</li>
  <li>
<a href="#plot-the-predictions" id="toc-plot-the-predictions" class="nav-link" data-scroll-target="#plot-the-predictions">Plot the predictions</a>
  <ul class="collapse">
<li><a href="#reconstruction-on-normal-data" id="toc-reconstruction-on-normal-data" class="nav-link" data-scroll-target="#reconstruction-on-normal-data">Reconstruction on Normal data</a></li>
  <li><a href="#reconstruction-on-anomalous-data" id="toc-reconstruction-on-anomalous-data" class="nav-link" data-scroll-target="#reconstruction-on-anomalous-data">Reconstruction on Anomalous data</a></li>
  </ul>
</li>
  <li>
<a href="#detect-anomalies" id="toc-detect-anomalies" class="nav-link" data-scroll-target="#detect-anomalies">Detect anomalies</a>
  <ul class="collapse">
<li><a href="#discover-the-threshold-to-flag-annomalies" id="toc-discover-the-threshold-to-flag-annomalies" class="nav-link" data-scroll-target="#discover-the-threshold-to-flag-annomalies">Discover the threshold to flag annomalies</a></li>
  <li><a href="#classify-anomalies" id="toc-classify-anomalies" class="nav-link" data-scroll-target="#classify-anomalies">Classify anomalies</a></li>
  </ul>
</li>
  <li><a href="#changelog" id="toc-changelog" class="nav-link" data-scroll-target="#changelog">Changelog</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next Steps</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Functional Auto Encoder with R Keras</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">tidymodels</div>
    <div class="quarto-category">tensorflow</div>
    <div class="quarto-category">code</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Bruno Testaguzza Carlin </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 31, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header><section id="objective" class="level1"><h1>Objective</h1>
<p>This is a somewhat simple post trying to mimic the guides on auto encoders present in <a href="https://www.tensorflow.org/tutorials/generative/autoencoder#third_example_anomaly_detection" title="Third example: Anomaly detection">Third example: Anomaly detection</a></p>
</section><section id="libraries" class="level1"><h1>Libraries</h1>
<p>Do keep in mind that in order to use tensorflow you should run</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tensorflow</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tensorflow/man/install_tensorflow.html">install_tensorflow</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://keras3.posit.co/">keras3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org">rsample</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes">recipes</a></span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/use_python.html">use_virtualenv</a></span><span class="op">(</span><span class="st">'py399'</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="download-the-dataset" class="level1"><h1>Download The Dataset</h1>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dataframe</span> <span class="op">&lt;-</span>  <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">'http://storage.googleapis.com/download.tensorflow.org/data/ecg.csv'</span>,col_names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Rows: 4998 Columns: 141
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
dbl (141): X1, X2, X3, X4, X5, X6, X7, X8, X9, X10, X11, X12, X13, X14, X15,...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dataframe</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["X1"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["X2"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["X3"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["X4"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["X5"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["X6"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["X7"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["X8"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["X9"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["X10"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["X11"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["X12"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["X13"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["X14"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["X15"],"name":[15],"type":["dbl"],"align":["right"]},{"label":["X16"],"name":[16],"type":["dbl"],"align":["right"]},{"label":["X17"],"name":[17],"type":["dbl"],"align":["right"]},{"label":["X18"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["X19"],"name":[19],"type":["dbl"],"align":["right"]},{"label":["X20"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["X21"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["X22"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["X23"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["X24"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["X25"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["X26"],"name":[26],"type":["dbl"],"align":["right"]},{"label":["X27"],"name":[27],"type":["dbl"],"align":["right"]},{"label":["X28"],"name":[28],"type":["dbl"],"align":["right"]},{"label":["X29"],"name":[29],"type":["dbl"],"align":["right"]},{"label":["X30"],"name":[30],"type":["dbl"],"align":["right"]},{"label":["X31"],"name":[31],"type":["dbl"],"align":["right"]},{"label":["X32"],"name":[32],"type":["dbl"],"align":["right"]},{"label":["X33"],"name":[33],"type":["dbl"],"align":["right"]},{"label":["X34"],"name":[34],"type":["dbl"],"align":["right"]},{"label":["X35"],"name":[35],"type":["dbl"],"align":["right"]},{"label":["X36"],"name":[36],"type":["dbl"],"align":["right"]},{"label":["X37"],"name":[37],"type":["dbl"],"align":["right"]},{"label":["X38"],"name":[38],"type":["dbl"],"align":["right"]},{"label":["X39"],"name":[39],"type":["dbl"],"align":["right"]},{"label":["X40"],"name":[40],"type":["dbl"],"align":["right"]},{"label":["X41"],"name":[41],"type":["dbl"],"align":["right"]},{"label":["X42"],"name":[42],"type":["dbl"],"align":["right"]},{"label":["X43"],"name":[43],"type":["dbl"],"align":["right"]},{"label":["X44"],"name":[44],"type":["dbl"],"align":["right"]},{"label":["X45"],"name":[45],"type":["dbl"],"align":["right"]},{"label":["X46"],"name":[46],"type":["dbl"],"align":["right"]},{"label":["X47"],"name":[47],"type":["dbl"],"align":["right"]},{"label":["X48"],"name":[48],"type":["dbl"],"align":["right"]},{"label":["X49"],"name":[49],"type":["dbl"],"align":["right"]},{"label":["X50"],"name":[50],"type":["dbl"],"align":["right"]},{"label":["X51"],"name":[51],"type":["dbl"],"align":["right"]},{"label":["X52"],"name":[52],"type":["dbl"],"align":["right"]},{"label":["X53"],"name":[53],"type":["dbl"],"align":["right"]},{"label":["X54"],"name":[54],"type":["dbl"],"align":["right"]},{"label":["X55"],"name":[55],"type":["dbl"],"align":["right"]},{"label":["X56"],"name":[56],"type":["dbl"],"align":["right"]},{"label":["X57"],"name":[57],"type":["dbl"],"align":["right"]},{"label":["X58"],"name":[58],"type":["dbl"],"align":["right"]},{"label":["X59"],"name":[59],"type":["dbl"],"align":["right"]},{"label":["X60"],"name":[60],"type":["dbl"],"align":["right"]},{"label":["X61"],"name":[61],"type":["dbl"],"align":["right"]},{"label":["X62"],"name":[62],"type":["dbl"],"align":["right"]},{"label":["X63"],"name":[63],"type":["dbl"],"align":["right"]},{"label":["X64"],"name":[64],"type":["dbl"],"align":["right"]},{"label":["X65"],"name":[65],"type":["dbl"],"align":["right"]},{"label":["X66"],"name":[66],"type":["dbl"],"align":["right"]},{"label":["X67"],"name":[67],"type":["dbl"],"align":["right"]},{"label":["X68"],"name":[68],"type":["dbl"],"align":["right"]},{"label":["X69"],"name":[69],"type":["dbl"],"align":["right"]},{"label":["X70"],"name":[70],"type":["dbl"],"align":["right"]},{"label":["X71"],"name":[71],"type":["dbl"],"align":["right"]},{"label":["X72"],"name":[72],"type":["dbl"],"align":["right"]},{"label":["X73"],"name":[73],"type":["dbl"],"align":["right"]},{"label":["X74"],"name":[74],"type":["dbl"],"align":["right"]},{"label":["X75"],"name":[75],"type":["dbl"],"align":["right"]},{"label":["X76"],"name":[76],"type":["dbl"],"align":["right"]},{"label":["X77"],"name":[77],"type":["dbl"],"align":["right"]},{"label":["X78"],"name":[78],"type":["dbl"],"align":["right"]},{"label":["X79"],"name":[79],"type":["dbl"],"align":["right"]},{"label":["X80"],"name":[80],"type":["dbl"],"align":["right"]},{"label":["X81"],"name":[81],"type":["dbl"],"align":["right"]},{"label":["X82"],"name":[82],"type":["dbl"],"align":["right"]},{"label":["X83"],"name":[83],"type":["dbl"],"align":["right"]},{"label":["X84"],"name":[84],"type":["dbl"],"align":["right"]},{"label":["X85"],"name":[85],"type":["dbl"],"align":["right"]},{"label":["X86"],"name":[86],"type":["dbl"],"align":["right"]},{"label":["X87"],"name":[87],"type":["dbl"],"align":["right"]},{"label":["X88"],"name":[88],"type":["dbl"],"align":["right"]},{"label":["X89"],"name":[89],"type":["dbl"],"align":["right"]},{"label":["X90"],"name":[90],"type":["dbl"],"align":["right"]},{"label":["X91"],"name":[91],"type":["dbl"],"align":["right"]},{"label":["X92"],"name":[92],"type":["dbl"],"align":["right"]},{"label":["X93"],"name":[93],"type":["dbl"],"align":["right"]},{"label":["X94"],"name":[94],"type":["dbl"],"align":["right"]},{"label":["X95"],"name":[95],"type":["dbl"],"align":["right"]},{"label":["X96"],"name":[96],"type":["dbl"],"align":["right"]},{"label":["X97"],"name":[97],"type":["dbl"],"align":["right"]},{"label":["X98"],"name":[98],"type":["dbl"],"align":["right"]},{"label":["X99"],"name":[99],"type":["dbl"],"align":["right"]},{"label":["X100"],"name":[100],"type":["dbl"],"align":["right"]},{"label":["X101"],"name":[101],"type":["dbl"],"align":["right"]},{"label":["X102"],"name":[102],"type":["dbl"],"align":["right"]},{"label":["X103"],"name":[103],"type":["dbl"],"align":["right"]},{"label":["X104"],"name":[104],"type":["dbl"],"align":["right"]},{"label":["X105"],"name":[105],"type":["dbl"],"align":["right"]},{"label":["X106"],"name":[106],"type":["dbl"],"align":["right"]},{"label":["X107"],"name":[107],"type":["dbl"],"align":["right"]},{"label":["X108"],"name":[108],"type":["dbl"],"align":["right"]},{"label":["X109"],"name":[109],"type":["dbl"],"align":["right"]},{"label":["X110"],"name":[110],"type":["dbl"],"align":["right"]},{"label":["X111"],"name":[111],"type":["dbl"],"align":["right"]},{"label":["X112"],"name":[112],"type":["dbl"],"align":["right"]},{"label":["X113"],"name":[113],"type":["dbl"],"align":["right"]},{"label":["X114"],"name":[114],"type":["dbl"],"align":["right"]},{"label":["X115"],"name":[115],"type":["dbl"],"align":["right"]},{"label":["X116"],"name":[116],"type":["dbl"],"align":["right"]},{"label":["X117"],"name":[117],"type":["dbl"],"align":["right"]},{"label":["X118"],"name":[118],"type":["dbl"],"align":["right"]},{"label":["X119"],"name":[119],"type":["dbl"],"align":["right"]},{"label":["X120"],"name":[120],"type":["dbl"],"align":["right"]},{"label":["X121"],"name":[121],"type":["dbl"],"align":["right"]},{"label":["X122"],"name":[122],"type":["dbl"],"align":["right"]},{"label":["X123"],"name":[123],"type":["dbl"],"align":["right"]},{"label":["X124"],"name":[124],"type":["dbl"],"align":["right"]},{"label":["X125"],"name":[125],"type":["dbl"],"align":["right"]},{"label":["X126"],"name":[126],"type":["dbl"],"align":["right"]},{"label":["X127"],"name":[127],"type":["dbl"],"align":["right"]},{"label":["X128"],"name":[128],"type":["dbl"],"align":["right"]},{"label":["X129"],"name":[129],"type":["dbl"],"align":["right"]},{"label":["X130"],"name":[130],"type":["dbl"],"align":["right"]},{"label":["X131"],"name":[131],"type":["dbl"],"align":["right"]},{"label":["X132"],"name":[132],"type":["dbl"],"align":["right"]},{"label":["X133"],"name":[133],"type":["dbl"],"align":["right"]},{"label":["X134"],"name":[134],"type":["dbl"],"align":["right"]},{"label":["X135"],"name":[135],"type":["dbl"],"align":["right"]},{"label":["X136"],"name":[136],"type":["dbl"],"align":["right"]},{"label":["X137"],"name":[137],"type":["dbl"],"align":["right"]},{"label":["X138"],"name":[138],"type":["dbl"],"align":["right"]},{"label":["X139"],"name":[139],"type":["dbl"],"align":["right"]},{"label":["X140"],"name":[140],"type":["dbl"],"align":["right"]},{"label":["X141"],"name":[141],"type":["dbl"],"align":["right"]}],"data":[{"1":"-0.1125218","2":"-2.8272038","3":"-3.773897","4":"-4.349751","5":"-4.376041","6":"-3.474986","7":"-2.181408","8":"-1.8182865","9":"-1.2505219","10":"-0.47749208","11":"-0.3638079","12":"-0.4919566","13":"-0.4218551","14":"-0.3092009","15":"-0.4959387","16":"-0.3421187","17":"-0.3553363","18":"-0.36791303","19":"-0.3165028","20":"-0.4123740","21":"-0.47167181","22":"-0.41345783","23":"-0.3646170","24":"-0.4492983","25":"-0.471418660","26":"-0.42477658","27":"-0.46251673","28":"-0.55247236","29":"-0.47537519","30":"-0.6942000","31":"-0.7018681","32":"-0.5938118","33":"-0.6606842","34":"-0.7138307","35":"-0.7698069","36":"-0.6722816","37":"-0.6536760","38":"-0.6394056","39":"-0.5593023","40":"-0.5916703","41":"-0.4932233","42":"-0.4630518","43":"-0.30164382","44":"-0.23273401","45":"-0.12505488","46":"-0.1539431","47":"-0.024357404","48":"-0.06560876","49":"0.03499926","50":"0.06193522","51":"0.07119542","52":"0.12392505","53":"0.103123710","54":"0.22522849","55":"0.12868305","56":"0.30248315","57":"0.25727621","58":"0.19635161","59":"0.17938297","60":"0.2447286","61":"0.34121687","62":"0.3282044","63":"0.4060417","64":"0.44660507","65":"0.4240682","66":"0.4815120","67":"0.4778438","68":"0.6240826","69":"0.5745846","70":"0.5980132","71":"0.5645919","72":"0.6079790","73":"0.6206346","74":"0.6562529","75":"0.6847481","76":"0.6942728","77":"0.6655838","78":"0.5757958","79":"0.6381348","80":"0.6149170","81":"0.5690834","82":"0.4685757","83":"0.4428178","84":"0.4682744","85":"0.4324929","86":"0.4079579","87":"0.4186226","88":"0.3625308","89":"0.4109590","90":"0.4716663","91":"0.3721668","92":"0.3378754","93":"0.2214051","94":"0.2739975","95":"0.2986641","96":"0.2635636","97":"0.3425635","98":"0.4195053","99":"0.5866074","100":"0.8606239","101":"1.1733446","102":"1.258179","103":"1.433789","104":"1.700533","105":"1.999043","106":"2.125341","107":"1.993291","108":"1.932246","109":"1.7974367","110":"1.5222839","111":"1.2511679","112":"0.99873034","113":"0.4837224","114":"0.02313229","115":"-0.1949138","116":"-0.22091729","117":"-0.2437367","118":"-0.2546946","119":"-0.2911356","120":"-0.2564903","121":"-0.2278743","122":"-0.3224228","123":"-0.2892859","124":"-0.31816951","125":"-0.3636536","126":"-0.3934558","127":"-0.2664189","128":"-0.25682316","129":"-0.2886940","130":"-0.16233755","131":"0.1603477","132":"0.7921679","133":"0.9335412","134":"0.7969578","135":"0.57862066","136":"0.2577399","137":"0.2280772","138":"0.1234308","139":"0.9252862","140":"0.1931374","141":"1"},{"1":"-1.1008778","2":"-3.9968398","3":"-4.285843","4":"-4.506579","5":"-4.022377","6":"-3.234368","7":"-1.566126","8":"-0.9922577","9":"-0.7546797","10":"0.04232117","11":"0.1489509","12":"0.1835271","13":"0.2948761","14":"0.1902327","15":"0.2355750","16":"0.2534871","17":"0.2217424","18":"0.05023326","19":"0.1780421","20":"0.1395632","21":"0.04679443","22":"0.04300714","23":"0.1065443","24":"0.0126540","25":"0.003994854","26":"0.04572418","27":"-0.04599936","28":"-0.07266696","29":"-0.07107791","30":"-0.1538665","31":"-0.2272544","32":"-0.2492697","33":"-0.2534894","34":"-0.3328352","35":"-0.2643300","36":"-0.3458252","37":"-0.3107811","38":"-0.3341598","39":"-0.3061779","40":"-0.1745625","41":"-0.2061602","42":"-0.2244797","43":"-0.04868393","44":"-0.01962116","45":"0.09480519","46":"0.1167864","47":"0.185185920","48":"0.23052577","49":"0.13802707","50":"0.24442554","51":"0.27169477","52":"0.25900331","53":"0.269201660","54":"0.12706463","55":"0.20207339","56":"0.25598343","57":"0.15311526","58":"0.21021583","59":"0.19108187","60":"0.1909270","61":"0.21051006","62":"0.2071076","63":"0.2048883","64":"0.20086474","65":"0.3469196","66":"0.3480019","67":"0.2545373","68":"0.3319746","69":"0.3566903","70":"0.3499298","71":"0.4303796","72":"0.4675016","73":"0.4860631","74":"0.4031884","75":"0.4789557","76":"0.3973918","77":"0.4641200","78":"0.4517954","79":"0.3613612","80":"0.3798309","81":"0.3427853","82":"0.3991066","83":"0.3875084","84":"0.2557035","85":"0.2840341","86":"0.2849926","87":"0.2501081","88":"0.1730363","89":"0.1494226","90":"0.1416850","91":"0.2222610","92":"0.1728471","93":"0.1507793","94":"0.1765660","95":"0.2809420","96":"0.4899390","97":"0.6608888","98":"0.8931933","99":"1.0269972","100":"1.2023937","101":"1.5574096","102":"1.808428","103":"2.164346","104":"2.070747","105":"1.903614","106":"1.764455","107":"1.507769","108":"1.293428","109":"0.8945621","110":"0.5780158","111":"0.2443431","112":"-0.28644345","113":"-0.5158813","114":"-0.73270694","115":"-0.8324655","116":"-0.80331806","117":"-0.8362525","118":"-0.7778646","119":"-0.7747530","120":"-0.7334039","121":"-0.7213863","122":"-0.8320952","123":"-0.7119816","124":"-0.75186730","125":"-0.7577196","126":"-0.8531197","127":"-0.7669884","128":"-0.68816064","129":"-0.5199235","130":"0.03940617","131":"0.5603268","132":"0.5383558","133":"0.6568808","134":"0.7874896","135":"0.72404623","136":"0.5557837","137":"0.4763333","138":"0.7738197","139":"1.1196209","140":"-1.4362499","141":"1"},{"1":"-0.5670880","2":"-2.5934502","3":"-3.874230","4":"-4.584095","5":"-4.187449","6":"-3.151462","7":"-1.742940","8":"-1.4906585","9":"-1.1835803","10":"-0.39422869","11":"-0.2828968","12":"-0.3569258","13":"-0.2872975","14":"-0.3994889","15":"-0.4732441","16":"-0.3790476","17":"-0.3990390","18":"-0.17859449","19":"-0.3395223","20":"-0.4984472","21":"-0.33725108","22":"-0.42547978","23":"-0.4239523","24":"-0.4631705","25":"-0.493253150","26":"-0.54974899","27":"-0.52983109","28":"-0.53093478","29":"-0.50236490","30":"-0.4173677","31":"-0.5263457","32":"-0.4710050","33":"-0.6767843","34":"-0.8986119","35":"-0.6105710","36":"-0.5301643","37":"-0.7656744","38":"-0.5819372","39":"-0.5378476","40":"-0.5563860","41":"-0.4380235","42":"-0.4362480","43":"-0.40011375","44":"-0.13498651","45":"-0.23934677","46":"-0.1202444","47":"-0.001971404","48":"0.28500048","49":"0.31564573","50":"0.10736401","51":"0.10952148","52":"0.15807843","53":"0.291897790","54":"0.26129450","55":"0.18840714","56":"0.14065136","57":"0.26336542","58":"0.28720706","59":"0.31431725","60":"0.1779424","61":"0.13829008","62":"0.3210687","63":"0.4581677","64":"0.25191615","65":"0.2613529","66":"0.2774875","67":"0.2987933","68":"0.4590753","69":"0.4191466","70":"0.5205089","71":"0.5377612","72":"0.6032107","73":"0.4756340","74":"0.5216929","75":"0.7352483","76":"0.7295411","77":"0.7185233","78":"0.4984332","79":"0.5454410","80":"0.6048267","81":"0.5212964","82":"0.3943806","83":"0.4050202","84":"0.5975630","85":"0.5311300","86":"0.3776509","87":"0.4677009","88":"0.4575693","89":"0.3411161","90":"0.4079132","91":"0.4591270","92":"0.4039366","93":"0.2981912","94":"0.4611005","95":"0.6646591","96":"0.5877572","97":"0.7013247","98":"0.9172046","99":"1.2479873","100":"1.5055679","101":"1.6401054","102":"1.810988","103":"2.185398","104":"2.262985","105":"2.052920","106":"1.890488","107":"1.793033","108":"1.564784","109":"1.2346189","110":"0.9003020","111":"0.5519571","112":"0.25822163","113":"-0.1285870","114":"-0.09258529","115":"-0.1686063","116":"-0.49598880","117":"-0.3950345","118":"-0.3282383","119":"-0.4481380","120":"-0.2682301","121":"-0.4564148","122":"-0.3578669","123":"-0.3175083","124":"-0.43411223","125":"-0.5492035","126":"-0.3246155","127":"-0.2680824","128":"-0.22038421","129":"-0.1174290","130":"0.61405916","131":"1.2848254","132":"0.8860734","133":"0.5314524","134":"0.3113768","135":"-0.02191896","136":"-0.7136834","137":"-0.5321967","138":"0.3210966","139":"0.9042267","140":"-0.4217966","141":"1"},{"1":"0.4904725","2":"-1.9144071","3":"-3.616364","4":"-4.318823","5":"-4.268016","6":"-3.881110","7":"-2.993280","8":"-1.6711314","9":"-1.3338845","10":"-0.96562916","11":"-0.1833186","12":"-0.1016566","13":"-0.2738744","14":"-0.1278176","15":"-0.1959835","16":"-0.2135229","17":"-0.1764727","18":"-0.15693160","19":"-0.1491723","20":"-0.1815100","21":"-0.18007406","22":"-0.24615133","23":"-0.2742599","24":"-0.1409596","25":"-0.277448770","26":"-0.38254906","27":"-0.31193709","28":"-0.36009264","29":"-0.40596818","30":"-0.5714334","31":"-0.5241056","32":"-0.5378865","33":"-0.6067775","34":"-0.6614462","35":"-0.6833748","36":"-0.7466826","37":"-0.6356621","38":"-0.6252309","39":"-0.5400938","40":"-0.6749949","41":"-0.6539490","42":"-0.5669164","43":"-0.52404493","44":"-0.41471114","45":"-0.38778691","46":"-0.2844373","47":"-0.072744620","48":"-0.16012546","49":"-0.09215954","50":"0.06716490","51":"0.08147214","52":"0.05618175","53":"0.024692229","54":"0.07439508","55":"0.15288791","56":"0.09103325","57":"0.11015952","58":"0.11727766","59":"0.11383231","60":"0.1418079","61":"0.27149224","62":"0.2497428","63":"0.1976078","64":"0.24393891","65":"0.3865384","66":"0.3000195","67":"0.3098010","68":"0.3446698","69":"0.3897099","70":"0.4428501","71":"0.4334296","72":"0.5487101","73":"0.5250366","74":"0.5219750","75":"0.6239537","76":"0.5491593","77":"0.6691888","78":"0.6299282","79":"0.5395734","80":"0.5992830","81":"0.4978532","82":"0.6380932","83":"0.6117370","84":"0.4919082","85":"0.5739486","86":"0.5162447","87":"0.5726297","88":"0.4845906","89":"0.3743818","90":"0.4617725","91":"0.4146607","92":"0.3716388","93":"0.4451696","94":"0.4841696","95":"0.5560606","96":"0.6587243","97":"0.8611579","98":"1.0163973","99":"1.1356060","100":"1.2169730","101":"1.5530785","102":"1.772155","103":"2.000769","104":"1.925003","105":"1.898426","106":"1.720953","107":"1.501711","108":"1.422492","109":"1.0232255","110":"0.7763413","111":"0.5044263","112":"0.05638187","113":"-0.2331606","114":"-0.40638829","115":"-0.3275280","116":"-0.46086800","117":"-0.4025356","118":"-0.3457516","119":"-0.3542065","120":"-0.4399588","121":"-0.4253259","122":"-0.4397887","123":"-0.4518353","124":"-0.39592642","125":"-0.4487623","126":"-0.3917891","127":"-0.3763075","128":"-0.46106907","129":"-0.2535244","130":"0.21300588","131":"0.4911732","132":"0.3508164","133":"0.4991106","134":"0.6003450","135":"0.84206940","136":"0.9520735","137":"0.9901332","138":"1.0867984","139":"1.4030110","140":"-0.3835643","141":"1"},{"1":"0.8002320","2":"-0.8742519","3":"-2.384761","4":"-3.973292","5":"-4.338224","6":"-3.802422","7":"-2.534510","8":"-1.7834233","9":"-1.5944504","10":"-0.75319899","11":"-0.2981066","12":"-0.4289280","13":"-0.4913508","14":"-0.3613042","15":"-0.3392955","16":"-0.3249515","17":"-0.2901133","18":"-0.36305106","19":"-0.5256838","20":"-0.5974230","21":"-0.57552317","22":"-0.56750306","23":"-0.5045548","24":"-0.6184062","25":"-0.682813540","26":"-0.74384873","27":"-0.81558784","28":"-0.82690193","29":"-0.78237433","30":"-0.9294620","31":"-0.9996717","32":"-1.0609695","33":"-1.0078773","34":"-1.0287349","35":"-1.1226293","36":"-1.0286499","37":"-1.0465146","38":"-1.0633724","39":"-1.1224228","40":"-0.9832420","41":"-0.8558653","42":"-0.7912660","43":"-0.58875425","44":"-0.51830558","45":"-0.39729838","46":"-0.3543328","47":"-0.207424920","48":"-0.08826602","49":"-0.16873361","50":"-0.06759208","51":"-0.03277228","52":"0.07189947","53":"0.081485179","54":"0.06722526","55":"0.13271969","56":"0.07024093","57":"0.10043175","58":"0.15041753","59":"0.10988654","60":"0.1488603","61":"0.20874762","62":"0.2282362","63":"0.2736642","64":"0.29952441","65":"0.3270623","66":"0.2423141","67":"0.3861052","68":"0.4190872","69":"0.4397179","70":"0.4889538","71":"0.5417151","72":"0.5738692","73":"0.6335548","74":"0.4116710","75":"0.4409173","76":"0.5887054","77":"0.5308650","78":"0.5589645","79":"0.6068742","80":"0.6147287","81":"0.5377716","82":"0.5992942","83":"0.6404630","84":"0.5683991","85":"0.5447105","86":"0.5579589","87":"0.5377615","88":"0.4722924","89":"0.4665956","90":"0.6344169","91":"0.4251749","92":"0.4207772","93":"0.4405230","94":"0.3610280","95":"0.3592994","96":"0.3213663","97":"0.4213255","98":"0.5051220","99":"0.6774887","100":"0.9086928","101":"0.9822303","102":"1.155363","103":"1.336254","104":"1.627534","105":"1.717594","106":"1.696487","107":"1.741686","108":"1.674078","109":"1.5469278","110":"1.3317385","111":"1.1101682","112":"0.92221037","113":"0.5217766","114":"0.15485176","115":"-0.1238607","116":"-0.20299778","117":"-0.2479560","118":"-0.2191218","119":"-0.2146952","120":"-0.3192147","121":"-0.1985971","122":"-0.1516179","123":"-0.1295926","124":"-0.07493893","125":"-0.1968070","126":"-0.1747948","127":"-0.2088327","128":"-0.21075375","129":"-0.1004854","130":"0.19744621","131":"0.9666060","132":"1.1488838","133":"0.9584343","134":"1.0590254","135":"1.37168230","136":"1.2773918","137":"0.9603039","138":"0.9710196","139":"1.6143924","140":"1.4214563","141":"1"},{"1":"-1.5076736","2":"-3.5745500","3":"-4.478011","4":"-4.408275","5":"-3.321242","6":"-2.105171","7":"-1.481048","8":"-1.3013622","9":"-0.4982396","10":"-0.28692830","11":"-0.3900309","12":"-0.2638416","13":"-0.3180242","14":"-0.1859156","15":"-0.2697900","16":"-0.3222454","17":"-0.3092531","18":"-0.39110135","19":"-0.3032594","20":"-0.3192919","21":"-0.40791759","22":"-0.42157915","23":"-0.4813804","24":"-0.4475185","25":"-0.524850400","26":"-0.46911847","27":"-0.58260667","28":"-0.67903585","29":"-0.65205179","30":"-0.8468528","31":"-0.7666816","32":"-0.7351483","33":"-0.7884646","34":"-0.8512765","35":"-0.8370098","36":"-0.8435009","37":"-0.8270417","38":"-0.8780608","39":"-0.7550946","40":"-0.8099210","41":"-0.6794154","42":"-0.5834180","43":"-0.45742032","44":"-0.37778498","45":"-0.36062856","46":"-0.2317265","47":"-0.236841600","48":"-0.04771065","49":"-0.05263242","50":"-0.07435492","51":"-0.09440888","52":"-0.08268415","53":"0.006754309","54":"-0.08292519","55":"-0.06149897","56":"0.02166685","57":"-0.04082262","58":"0.03808829","59":"0.04111276","60":"-0.1071657","61":"0.03470133","62":"0.0857038","63":"0.1218563","64":"0.08889131","65":"0.1856777","66":"0.2299073","67":"0.1832041","68":"0.2868453","69":"0.2795620","70":"0.4185915","71":"0.3946094","72":"0.4276403","73":"0.4448439","74":"0.4682988","75":"0.5154246","76":"0.6362953","77":"0.6332517","78":"0.6446601","79":"0.6275454","80":"0.5300407","81":"0.4928233","82":"0.4792082","83":"0.4133600","84":"0.4756238","85":"0.4364935","86":"0.4068417","87":"0.4433003","88":"0.3176839","89":"0.3613207","90":"0.3610005","91":"0.2414258","92":"0.3181150","93":"0.3251511","94":"0.4783047","95":"0.4760798","96":"0.5320627","97":"0.7954846","98":"0.9451694","99":"1.1049370","100":"1.2906530","101":"1.4892172","102":"1.755300","103":"1.960918","104":"2.042437","105":"1.902829","106":"1.902875","107":"1.758074","108":"1.425782","109":"1.2102201","110":"0.9283974","111":"0.6412640","112":"0.17552516","113":"-0.1069101","114":"-0.13204268","115":"-0.1658357","116":"-0.09857054","117":"-0.2660220","118":"-0.2372939","119":"-0.1376878","120":"-0.1006746","121":"-0.1074989","122":"-0.2103621","123":"-0.1301039","124":"-0.10763115","125":"-0.1611459","126":"-0.1013163","127":"-0.0952555","128":"-0.06917216","129":"0.1548778","130":"0.69565622","131":"1.2149308","132":"1.0890684","133":"0.9833686","134":"1.0141238","135":"0.95262870","136":"0.7493260","137":"1.0070757","138":"1.6349896","139":"1.4933655","140":"-0.7831344","141":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="va">dataframe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="preprocessing" class="level1"><h1>Preprocessing</h1>
<section id="split-the-data" class="level2"><h2 class="anchored" data-anchor-id="split-the-data">Split the data</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raw_data_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">initial_split</a></span><span class="op">(</span><span class="va">raw_data</span>,prop <span class="op">=</span> <span class="fl">.8</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">training</a></span><span class="op">(</span><span class="va">raw_data_split</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html">testing</a></span><span class="op">(</span><span class="va">raw_data_split</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="normalize-the-data-to-01." class="level2"><h2 class="anchored" data-anchor-id="normalize-the-data-to-01.">Normalize the data to [0,1].</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">target_varible</span> <span class="op">&lt;-</span> <span class="va">raw_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">raw_data</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">recipe_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html">recipe</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span><span class="op">(</span><span class="va">target_varible</span>,new_role <span class="op">=</span> <span class="st">'outcome'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/roles.html">update_role</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span>,new_role <span class="op">=</span> <span class="st">'predictor'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_range.html">step_range</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html">all_predictors</a></span><span class="op">(</span><span class="op">)</span>,min <span class="op">=</span> <span class="fl">0</span>,max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: Using an external vector in selections was deprecated in tidyselect 1.1.0.
ℹ Please use `all_of()` or `any_of()` instead.
  # Was:
  data %&gt;% select(target_varible)

  # Now:
  data %&gt;% select(all_of(target_varible))

See &lt;https://tidyselect.r-lib.org/reference/faq-external-vector.html&gt;.</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">preped_recipe_data</span> <span class="op">&lt;-</span> <span class="va">recipe_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html">prep</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">baked_train_data</span> <span class="op">&lt;-</span> <span class="va">preped_recipe_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span>new_data <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">baked_test_data</span> <span class="op">&lt;-</span> <span class="va">preped_recipe_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html">bake</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="separate-datasets-for-future-usage" class="level2"><h2 class="anchored" data-anchor-id="separate-datasets-for-future-usage">Separate datasets for future usage</h2>
<p>You will train the autoencoder using only the normal rhythms</p>
<p>Which are labeled in this dataset as 1.</p>
<p>Separate the normal rhythms from the abnormal rhythms.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">normal_train_data</span> <span class="op">&lt;-</span>  <span class="va">baked_train_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">normal_test_data</span> <span class="op">&lt;-</span>  <span class="va">baked_test_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anomalous_train_data</span> <span class="op">&lt;-</span>  <span class="va">baked_train_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">anomalous_test_data</span> <span class="op">&lt;-</span>  <span class="va">baked_test_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span><span class="op">(</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="see-the-data" class="level1"><h1>See the data</h1>
<section id="normal-ecg" class="level2"><h2 class="anchored" data-anchor-id="normal-ecg">Normal ECG</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Plot a normal ECG.</span></span>
<span></span>
<span><span class="va">normal_train_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span> <span class="op">|&gt;</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="st">'\\d+'</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">name</span>,y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'A Normal ECG'</span>,x <span class="op">=</span> <span class="cn">NULL</span>,y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="anomalous-ecg" class="level2"><h2 class="anchored" data-anchor-id="anomalous-ecg">Anomalous ECG</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anomalous_train_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span> <span class="op">|&gt;</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="st">'\\d+'</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">name</span>,y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'A Anomalous ECG'</span>,x <span class="op">=</span> <span class="cn">NULL</span>,y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="create-matrixes-for-tensorflow" class="level1"><h1>Create Matrixes for tensorflow</h1>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">normal_train_data_x</span> <span class="op">&lt;-</span> <span class="va">normal_train_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">normal_test_data_x</span> <span class="op">&lt;-</span> <span class="va">normal_test_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_data_x</span> <span class="op">&lt;-</span> <span class="va">baked_test_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anomalous_test_data_x</span> <span class="op">&lt;-</span> <span class="va">anomalous_test_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="build-the-auto-encoder--using-the-functional-api" class="level1"><h1>Build The Auto Encoder- Using the functional api</h1>
<section id="discover-the-input-and-output-dimensions" class="level2"><h2 class="anchored" data-anchor-id="discover-the-input-and-output-dimensions">Discover the input and output dimensions</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># dim_features is the dimension of your features</span></span>
<span><span class="va">dim_features</span> <span class="op">&lt;-</span> <span class="va">normal_train_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># latent dim is usually the smallest layer of the network at the end of the encoder model</span></span>
<span><span class="va">latent_dim</span> <span class="op">&lt;-</span> <span class="fl">8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="define-the-encoder" class="level2"><h2 class="anchored" data-anchor-id="define-the-encoder">Define the encoder</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>sys.executable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>'/home/carlin/.virtualenvs/py399/bin/python'</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#|warning: false</span></span>
<span><span class="va">encoder_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_input.html">layer_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">dim_features</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"features"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">encoder_output</span> <span class="op">&lt;-</span> <span class="va">encoder_input</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">32</span>,activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">16</span>,activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="va">latent_dim</span>,activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">encoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">encoder_input</span>, <span class="va">encoder_output</span>, name <span class="op">=</span> <span class="st">"encoder"</span><span class="op">)</span></span>
<span><span class="va">encoder</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Model: "encoder"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                      ┃ Output Shape             ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ features (InputLayer)             │ (None, 140)              │             0 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ dense (Dense)                     │ (None, 32)               │         4,512 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ dense_1 (Dense)                   │ (None, 16)               │           528 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ dense_2 (Dense)                   │ (None, 8)                │           136 │
└───────────────────────────────────┴──────────────────────────┴───────────────┘
 Total params: 5,176 (20.22 KB)
 Trainable params: 5,176 (20.22 KB)
 Non-trainable params: 0 (0.00 B)</code></pre>
</div>
</div>
</section><section id="define-decoder" class="level2"><h2 class="anchored" data-anchor-id="define-decoder">Define Decoder</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">decoder_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/layer_input.html">layer_input</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">latent_dim</span><span class="op">)</span>, name <span class="op">=</span> <span class="st">"latent_dim"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">decoder_output</span> <span class="op">&lt;-</span> <span class="va">decoder_input</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">16</span>,activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="fl">32</span>,activation <span class="op">=</span> <span class="st">"relu"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://keras3.posit.co/reference/layer_dense.html">layer_dense</a></span><span class="op">(</span><span class="va">dim_features</span>,activation <span class="op">=</span> <span class="st">"sigmoid"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">decoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">decoder_input</span>, <span class="va">decoder_output</span>, name <span class="op">=</span> <span class="st">"decoder"</span><span class="op">)</span></span>
<span><span class="va">decoder</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Model: "decoder"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                      ┃ Output Shape             ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ latent_dim (InputLayer)           │ (None, 8)                │             0 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ dense_3 (Dense)                   │ (None, 16)               │           144 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ dense_4 (Dense)                   │ (None, 32)               │           544 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ dense_5 (Dense)                   │ (None, 140)              │         4,620 │
└───────────────────────────────────┴──────────────────────────┴───────────────┘
 Total params: 5,308 (20.73 KB)
 Trainable params: 5,308 (20.73 KB)
 Non-trainable params: 0 (0.00 B)</code></pre>
</div>
</div>
</section><section id="define-the-auto-encoder" class="level2"><h2 class="anchored" data-anchor-id="define-the-auto-encoder">Define The Auto Encoder</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">encoded</span> <span class="op">&lt;-</span> <span class="fu">encoder</span><span class="op">(</span><span class="va">encoder_input</span><span class="op">)</span></span>
<span><span class="va">decoded</span> <span class="op">&lt;-</span> <span class="fu">decoder</span><span class="op">(</span><span class="va">encoded</span><span class="op">)</span></span>
<span><span class="va">autoencoder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://keras3.posit.co/reference/keras_model.html">keras_model</a></span><span class="op">(</span><span class="va">encoder_input</span>, <span class="va">decoded</span>,</span>
<span>                           name <span class="op">=</span> <span class="st">"autoencoder"</span><span class="op">)</span></span>
<span><span class="va">autoencoder</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Model: "autoencoder"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                      ┃ Output Shape             ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ features (InputLayer)             │ (None, 140)              │             0 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ encoder (Functional)              │ (None, 8)                │         5,176 │
├───────────────────────────────────┼──────────────────────────┼───────────────┤
│ decoder (Functional)              │ (None, 140)              │         5,308 │
└───────────────────────────────────┴──────────────────────────┴───────────────┘
 Total params: 10,484 (40.95 KB)
 Trainable params: 10,484 (40.95 KB)
 Non-trainable params: 0 (0.00 B)</code></pre>
</div>
</div>
</section><section id="fit-the-model" class="level2"><h2 class="anchored" data-anchor-id="fit-the-model">Fit the model</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">history</span> <span class="op">&lt;-</span> <span class="va">autoencoder</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/compile.html">compile</a></span><span class="op">(</span>loss <span class="op">=</span> <span class="st">"mae"</span>,</span>
<span>          optimizer <span class="op">=</span> <span class="st">"adam"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">normal_train_data_x</span>,</span>
<span>    y <span class="op">=</span> <span class="va">normal_train_data_x</span>,</span>
<span>    epochs <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fl">512</span>,</span>
<span>    validation_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      <span class="va">test_data_x</span>,</span>
<span>      <span class="va">test_data_x</span></span>
<span>    <span class="op">)</span>,</span>
<span>    shuffle <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/20
5/5 - 1s - 187ms/step - loss: 0.1349 - val_loss: 0.1405
Epoch 2/20
5/5 - 0s - 8ms/step - loss: 0.1308 - val_loss: 0.1346
Epoch 3/20
5/5 - 0s - 8ms/step - loss: 0.1234 - val_loss: 0.1252
Epoch 4/20
5/5 - 0s - 8ms/step - loss: 0.1132 - val_loss: 0.1158
Epoch 5/20
5/5 - 0s - 8ms/step - loss: 0.1036 - val_loss: 0.1086
Epoch 6/20
5/5 - 0s - 8ms/step - loss: 0.0942 - val_loss: 0.1005
Epoch 7/20
5/5 - 0s - 8ms/step - loss: 0.0844 - val_loss: 0.0936
Epoch 8/20
5/5 - 0s - 8ms/step - loss: 0.0759 - val_loss: 0.0877
Epoch 9/20
5/5 - 0s - 8ms/step - loss: 0.0686 - val_loss: 0.0833
Epoch 10/20
5/5 - 0s - 8ms/step - loss: 0.0627 - val_loss: 0.0799
Epoch 11/20
5/5 - 0s - 7ms/step - loss: 0.0582 - val_loss: 0.0778
Epoch 12/20
5/5 - 0s - 8ms/step - loss: 0.0551 - val_loss: 0.0765
Epoch 13/20
5/5 - 0s - 8ms/step - loss: 0.0531 - val_loss: 0.0757
Epoch 14/20
5/5 - 0s - 8ms/step - loss: 0.0516 - val_loss: 0.0752
Epoch 15/20
5/5 - 0s - 8ms/step - loss: 0.0503 - val_loss: 0.0746
Epoch 16/20
5/5 - 0s - 8ms/step - loss: 0.0494 - val_loss: 0.0745
Epoch 17/20
5/5 - 0s - 8ms/step - loss: 0.0486 - val_loss: 0.0742
Epoch 18/20
5/5 - 0s - 8ms/step - loss: 0.0480 - val_loss: 0.0741
Epoch 19/20
5/5 - 0s - 7ms/step - loss: 0.0475 - val_loss: 0.0740
Epoch 20/20
5/5 - 0s - 7ms/step - loss: 0.0471 - val_loss: 0.0739</code></pre>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">history</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="plot-the-predictions" class="level1"><h1>Plot the predictions</h1>
<section id="reconstruction-on-normal-data" class="level2"><h2 class="anchored" data-anchor-id="reconstruction-on-normal-data">Reconstruction on Normal data</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">encoded_data</span> <span class="op">&lt;-</span> <span class="va">encoder</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">normal_test_data_x</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>19/19 - 0s - 3ms/step</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">decoded_data</span> <span class="op">&lt;-</span> <span class="va">decoder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">encoded_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>19/19 - 0s - 3ms/step</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">decoded_data_to_plot</span> <span class="op">&lt;-</span> <span class="va">decoded_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,values_to <span class="op">=</span> <span class="st">'Reconstruction'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span> <span class="op">|&gt;</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="st">'\\d+'</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: The `x` argument of `as_tibble.matrix()` must have unique column names if
`.name_repair` is omitted as of tibble 2.0.0.
ℹ Using compatibility `.name_repair`.</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">normal_test_data_to_plot</span> <span class="op">&lt;-</span> <span class="va">normal_test_data_x</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,values_to <span class="op">=</span> <span class="st">'Input'</span><span class="op">)</span><span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span> <span class="op">|&gt;</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="st">'\\d+'</span><span class="op">)</span><span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_to_plot</span> <span class="op">&lt;-</span> <span class="va">decoded_data_to_plot</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">normal_test_data_to_plot</span>,by <span class="op">=</span> <span class="st">'name'</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">data_to_plot</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">name</span>,names_to <span class="op">=</span> <span class="st">'source'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">name</span>,y <span class="op">=</span> <span class="va">value</span>,colour <span class="op">=</span> <span class="va">source</span>,group <span class="op">=</span> <span class="va">source</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Recontruction on test data'</span>,x <span class="op">=</span> <span class="cn">NULL</span>,y<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="reconstruction-on-anomalous-data" class="level2"><h2 class="anchored" data-anchor-id="reconstruction-on-anomalous-data">Reconstruction on Anomalous data</h2>
<p>It is clear that the reconstruction can’t quite create the output, this is what we will exploit to define outliers.</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">encoded_data</span> <span class="op">&lt;-</span> <span class="va">encoder</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">anomalous_test_data_x</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>14/14 - 0s - 2ms/step</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">decoded_data</span> <span class="op">&lt;-</span> <span class="va">decoder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">encoded_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>14/14 - 0s - 1ms/step</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">decoded_data_to_plot</span> <span class="op">&lt;-</span> <span class="va">decoded_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,values_to <span class="op">=</span> <span class="st">'Reconstruction'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span> <span class="op">|&gt;</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="st">'\\d+'</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">normal_test_data_to_plot</span> <span class="op">&lt;-</span> <span class="va">anomalous_test_data_x</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,values_to <span class="op">=</span> <span class="st">'Input'</span><span class="op">)</span><span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">name</span> <span class="op">|&gt;</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="st">'\\d+'</span><span class="op">)</span><span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_to_plot</span> <span class="op">&lt;-</span> <span class="va">decoded_data_to_plot</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">normal_test_data_to_plot</span>,by <span class="op">=</span> <span class="st">'name'</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">data_to_plot</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">name</span>,names_to <span class="op">=</span> <span class="st">'source'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">name</span>,y <span class="op">=</span> <span class="va">value</span>,colour <span class="op">=</span> <span class="va">source</span>,group <span class="op">=</span> <span class="va">source</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Recontruction on Anomalous test data'</span>,x <span class="op">=</span> <span class="cn">NULL</span>,y<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="detect-anomalies" class="level1"><h1>Detect anomalies</h1>
<section id="discover-the-threshold-to-flag-annomalies" class="level2"><h2 class="anchored" data-anchor-id="discover-the-threshold-to-flag-annomalies">Discover the threshold to flag annomalies</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">reconstructions</span> <span class="op">&lt;-</span>  <span class="va">autoencoder</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">normal_train_data_x</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>73/73 - 0s - 1ms/step</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_data_tibble</span> <span class="op">&lt;-</span> <span class="va">normal_train_data_x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">train_loss</span> <span class="op">=</span> <span class="fu"><a href="https://keras3.posit.co/reference/loss_mean_squared_error.html">loss_mean_squared_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">reconstructions</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">train_data_tibble</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_loss</span> <span class="op">&lt;-</span> <span class="va">train_loss</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_loss</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Loss Normal Train Data'</span>,x <span class="op">=</span> <span class="st">'Train Loss'</span>, y <span class="op">=</span> <span class="st">'No of examples'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">threshold</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">train_loss</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">threshold</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01256173</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Completness
</div>
</div>
<div class="callout-body-container callout-body">
<p>There are other strategies you could use to select a threshold value above which test examples should be classified as anomalous, the correct approach will depend on your dataset. You can learn more with the links at the end of this tutorial.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Strategy
</div>
</div>
<div class="callout-body-container callout-body">
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you examine the reconstruction error for the anomalous examples in the test set, you’ll notice most have greater reconstruction error than the threshold. By varing the threshold, you can adjust the precision and recall of your classifier.</p>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
tidy.outliers
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you need something faster, and usually more practical do check out my package tidy.outliers for easy to use outlier detection methods.</p>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">reconstructions</span> <span class="op">&lt;-</span>  <span class="va">autoencoder</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">anomalous_test_data_x</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>14/14 - 0s - 4ms/step</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anomalous_test_data_x_tibble</span> <span class="op">&lt;-</span> <span class="va">anomalous_test_data_x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_loss</span> <span class="op">=</span> <span class="fu"><a href="https://keras3.posit.co/reference/loss_mean_squared_error.html">loss_mean_squared_error</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">reconstructions</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">anomalous_test_data_x_tibble</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_loss</span> <span class="op">&lt;-</span> <span class="va">test_loss</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_loss</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Loss Anomalous Test Data'</span>,x <span class="op">=</span> <span class="st">'Test Loss'</span>, y <span class="op">=</span> <span class="st">'No of examples'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="classify-anomalies" class="level2"><h2 class="anchored" data-anchor-id="classify-anomalies">Classify anomalies</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">predict_outlier</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>,<span class="va">data</span>,<span class="va">threshold</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">reconstructions</span> <span class="op">&lt;-</span>  <span class="va">model</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">loss</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://keras3.posit.co/reference/loss_mean_squared_error.html">loss_mean_squared_error</a></span><span class="op">(</span><span class="va">reconstructions</span>, <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">df_result</span> <span class="op">&lt;-</span> <span class="fu">keras</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/keras/man/k_less.html">k_less</a></span><span class="op">(</span><span class="va">loss</span>,<span class="va">threshold</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>estimate <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df_result</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu">predict_outlier</span><span class="op">(</span><span class="va">autoencoder</span>,<span class="va">anomalous_test_data_x</span>,<span class="va">threshold</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>14/14 - 0s - 2ms/step</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 methods overwritten by 'keras':
  method                               from  
  as.data.frame.keras_training_history keras3
  plot.keras_training_history          keras3
  print.keras_training_history         keras3
  r_to_py.R6ClassGenerator             keras3</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="va">anomalous_test_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">target_varible</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">truth</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_result</span> <span class="op">&lt;-</span> <span class="va">test_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df_result</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/accuracy.html">accuracy</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">truth</span>,estimate <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"accuracy","2":"binary","3":"0.9736211"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_result</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/precision.html">precision</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">truth</span>,estimate <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"precision","2":"binary","3":"1"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_result</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/recall.html">recall</a></span><span class="op">(</span>truth <span class="op">=</span> <span class="va">truth</span>,estimate <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[".metric"],"name":[1],"type":["chr"],"align":["left"]},{"label":[".estimator"],"name":[2],"type":["chr"],"align":["left"]},{"label":[".estimate"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"recall","2":"binary","3":"0.9736211"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section></section><section id="changelog" class="level1"><h1>Changelog</h1>
<p>2024-02-09 Updated to Keras3.</p>
</section><section id="next-steps" class="level1"><h1>Next Steps</h1>
<p>Check out the <a href="https://www.tensorflow.org/tutorials/generative/autoencoder#next_steps" title="Tensorflow Next Steps">Tensorflow Next Steps</a></p>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/quartopub\.com\/sites\/carlin\/bruno-testaguzza-carlin");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="brunocarlin/quarto_carlin_website" data-repo-id="R_kgDOID62lQ" data-category="General" data-category-id="DIC_kwDOID62lc4CRnbw" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb54" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Functional Auto Encoder with R Keras"</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Bruno Testaguzza Carlin"</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> "autoencoder.png"</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="an">df-print:</span><span class="co"> paged</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="an">code-tools:</span><span class="co"> true</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="an">code-fold:</span><span class="co"> show</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="an">code-link:</span><span class="co"> true</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [tidymodels,tensorflow,code]</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2023-03-31</span></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="fu"># Objective</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>This is a somewhat simple post trying to mimic the guides on auto encoders present in <span class="co">[</span><span class="ot">Third example: Anomaly detection</span><span class="co">](https://www.tensorflow.org/tutorials/generative/autoencoder#third_example_anomaly_detection "Third example: Anomaly detection")</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="fu"># Libraries</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>Do keep in mind that in order to use tensorflow you should run</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="in">``` r</span></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>tensorflow<span class="sc">::</span><span class="fu">install_tensorflow</span>()</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="in">```{r,warning=FALSE}</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a><span class="in">library(keras3)</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a><span class="in">library(rsample) |&gt; suppressMessages()</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a><span class="in">library(recipes) |&gt; suppressMessages()</span></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyr)</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>reticulate<span class="sc">::</span><span class="fu">use_virtualenv</span>(<span class="st">'py399'</span>)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a><span class="fu"># Download The Dataset</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>dataframe <span class="ot">&lt;-</span>  readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">'http://storage.googleapis.com/download.tensorflow.org/data/ecg.csv'</span>,<span class="at">col_names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>dataframe <span class="sc">|&gt;</span> <span class="fu">head</span>()</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> dataframe</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a><span class="fu"># Preprocessing</span></span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## Split the data</span></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20</span>)</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>raw_data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(raw_data,<span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(raw_data_split)</span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">testing</span>(raw_data_split)</span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## Normalize the data to \[0,1\].</span></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>target_varible <span class="ot">&lt;-</span> raw_data[,<span class="fu">ncol</span>(raw_data)] <span class="sc">|&gt;</span> <span class="fu">names</span>()</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a>recipe_data <span class="ot">&lt;-</span> <span class="fu">recipe</span>(train_data) <span class="sc">|&gt;</span> </span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(target_varible,<span class="at">new_role =</span> <span class="st">'outcome'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="sc">-</span>target_varible,<span class="at">new_role =</span> <span class="st">'predictor'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_range</span>(<span class="fu">all_predictors</span>(),<span class="at">min =</span> <span class="dv">0</span>,<span class="at">max =</span> <span class="dv">1</span>)</span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>preped_recipe_data <span class="ot">&lt;-</span> recipe_data <span class="sc">|&gt;</span> <span class="fu">prep</span>(train_data)</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a>baked_train_data <span class="ot">&lt;-</span> preped_recipe_data <span class="sc">|&gt;</span> <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>baked_test_data <span class="ot">&lt;-</span> preped_recipe_data <span class="sc">|&gt;</span> <span class="fu">bake</span>(test_data)</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a><span class="fu">## Separate datasets for future usage</span></span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a>You will train the autoencoder using only the normal rhythms</span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a>Which are labeled in this dataset as 1.</span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a>Separate the normal rhythms from the abnormal rhythms.</span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>normal_train_data <span class="ot">&lt;-</span>  baked_train_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">get</span>(target_varible) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a>normal_test_data <span class="ot">&lt;-</span>  baked_test_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">get</span>(target_varible) <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a>anomalous_train_data <span class="ot">&lt;-</span>  baked_train_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">get</span>(target_varible) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a>anomalous_test_data <span class="ot">&lt;-</span>  baked_test_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">get</span>(target_varible) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a><span class="fu"># See the data</span></span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a><span class="fu">## Normal ECG</span></span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a normal ECG.</span></span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>normal_train_data <span class="sc">|&gt;</span> </span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>target_varible) <span class="sc">|&gt;</span></span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> name <span class="sc">|&gt;</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">d+'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> name,<span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'A Normal ECG'</span>,<span class="at">x =</span> <span class="cn">NULL</span>,<span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a><span class="fu">## Anomalous ECG</span></span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a>anomalous_train_data <span class="sc">|&gt;</span> </span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>target_varible) <span class="sc">|&gt;</span></span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> name <span class="sc">|&gt;</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">d+'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> name,<span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'A Anomalous ECG'</span>,<span class="at">x =</span> <span class="cn">NULL</span>,<span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a><span class="fu"># Create Matrixes for tensorflow</span></span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-140"><a href="#cb54-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-141"><a href="#cb54-141" aria-hidden="true" tabindex="-1"></a>normal_train_data_x <span class="ot">&lt;-</span> normal_train_data <span class="sc">|&gt;</span></span>
<span id="cb54-142"><a href="#cb54-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>target_varible) <span class="sc">|&gt;</span> </span>
<span id="cb54-143"><a href="#cb54-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb54-144"><a href="#cb54-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-145"><a href="#cb54-145" aria-hidden="true" tabindex="-1"></a>normal_test_data_x <span class="ot">&lt;-</span> normal_test_data <span class="sc">|&gt;</span></span>
<span id="cb54-146"><a href="#cb54-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>target_varible) <span class="sc">|&gt;</span> </span>
<span id="cb54-147"><a href="#cb54-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb54-148"><a href="#cb54-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-149"><a href="#cb54-149" aria-hidden="true" tabindex="-1"></a>test_data_x <span class="ot">&lt;-</span> baked_test_data <span class="sc">|&gt;</span> </span>
<span id="cb54-150"><a href="#cb54-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>target_varible) <span class="sc">|&gt;</span> </span>
<span id="cb54-151"><a href="#cb54-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb54-152"><a href="#cb54-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-153"><a href="#cb54-153" aria-hidden="true" tabindex="-1"></a>anomalous_test_data_x <span class="ot">&lt;-</span> anomalous_test_data <span class="sc">|&gt;</span> </span>
<span id="cb54-154"><a href="#cb54-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>target_varible) <span class="sc">|&gt;</span> </span>
<span id="cb54-155"><a href="#cb54-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb54-156"><a href="#cb54-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-157"><a href="#cb54-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-158"><a href="#cb54-158" aria-hidden="true" tabindex="-1"></a><span class="fu"># Build The Auto Encoder- Using the functional api</span></span>
<span id="cb54-159"><a href="#cb54-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-160"><a href="#cb54-160" aria-hidden="true" tabindex="-1"></a><span class="fu">## Discover the input and output dimensions</span></span>
<span id="cb54-161"><a href="#cb54-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-164"><a href="#cb54-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-165"><a href="#cb54-165" aria-hidden="true" tabindex="-1"></a><span class="co"># dim_features is the dimension of your features</span></span>
<span id="cb54-166"><a href="#cb54-166" aria-hidden="true" tabindex="-1"></a>dim_features <span class="ot">&lt;-</span> normal_train_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>target_varible) <span class="sc">|&gt;</span> <span class="fu">ncol</span>()</span>
<span id="cb54-167"><a href="#cb54-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-168"><a href="#cb54-168" aria-hidden="true" tabindex="-1"></a><span class="co"># latent dim is usually the smallest layer of the network at the end of the encoder model</span></span>
<span id="cb54-169"><a href="#cb54-169" aria-hidden="true" tabindex="-1"></a>latent_dim <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb54-170"><a href="#cb54-170" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-171"><a href="#cb54-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-172"><a href="#cb54-172" aria-hidden="true" tabindex="-1"></a><span class="fu">## Define the encoder</span></span>
<span id="cb54-173"><a href="#cb54-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-176"><a href="#cb54-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-177"><a href="#cb54-177" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb54-178"><a href="#cb54-178" aria-hidden="true" tabindex="-1"></a>sys.executable</span>
<span id="cb54-179"><a href="#cb54-179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-180"><a href="#cb54-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-183"><a href="#cb54-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-184"><a href="#cb54-184" aria-hidden="true" tabindex="-1"></a><span class="co">#|warning: false</span></span>
<span id="cb54-185"><a href="#cb54-185" aria-hidden="true" tabindex="-1"></a>encoder_input <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> <span class="fu">c</span>(dim_features), <span class="at">name =</span> <span class="st">"features"</span>)</span>
<span id="cb54-186"><a href="#cb54-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-187"><a href="#cb54-187" aria-hidden="true" tabindex="-1"></a>encoder_output <span class="ot">&lt;-</span> encoder_input <span class="sc">|&gt;</span> </span>
<span id="cb54-188"><a href="#cb54-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="dv">32</span>,<span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-189"><a href="#cb54-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="dv">16</span>,<span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-190"><a href="#cb54-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(latent_dim,<span class="at">activation =</span> <span class="st">"relu"</span>)</span>
<span id="cb54-191"><a href="#cb54-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-192"><a href="#cb54-192" aria-hidden="true" tabindex="-1"></a>encoder <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(encoder_input, encoder_output, <span class="at">name =</span> <span class="st">"encoder"</span>)</span>
<span id="cb54-193"><a href="#cb54-193" aria-hidden="true" tabindex="-1"></a>encoder</span>
<span id="cb54-194"><a href="#cb54-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-195"><a href="#cb54-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-196"><a href="#cb54-196" aria-hidden="true" tabindex="-1"></a><span class="fu">## Define Decoder</span></span>
<span id="cb54-197"><a href="#cb54-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-200"><a href="#cb54-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-201"><a href="#cb54-201" aria-hidden="true" tabindex="-1"></a>decoder_input <span class="ot">&lt;-</span> <span class="fu">layer_input</span>(<span class="at">shape =</span> <span class="fu">c</span>(latent_dim), <span class="at">name =</span> <span class="st">"latent_dim"</span>)</span>
<span id="cb54-202"><a href="#cb54-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-203"><a href="#cb54-203" aria-hidden="true" tabindex="-1"></a>decoder_output <span class="ot">&lt;-</span> decoder_input <span class="sc">|&gt;</span> </span>
<span id="cb54-204"><a href="#cb54-204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="dv">16</span>,<span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-205"><a href="#cb54-205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(<span class="dv">32</span>,<span class="at">activation =</span> <span class="st">"relu"</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-206"><a href="#cb54-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">layer_dense</span>(dim_features,<span class="at">activation =</span> <span class="st">"sigmoid"</span>)</span>
<span id="cb54-207"><a href="#cb54-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-208"><a href="#cb54-208" aria-hidden="true" tabindex="-1"></a>decoder <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(decoder_input, decoder_output, <span class="at">name =</span> <span class="st">"decoder"</span>)</span>
<span id="cb54-209"><a href="#cb54-209" aria-hidden="true" tabindex="-1"></a>decoder</span>
<span id="cb54-210"><a href="#cb54-210" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-211"><a href="#cb54-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-212"><a href="#cb54-212" aria-hidden="true" tabindex="-1"></a><span class="fu">## Define The Auto Encoder</span></span>
<span id="cb54-213"><a href="#cb54-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-216"><a href="#cb54-216" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-217"><a href="#cb54-217" aria-hidden="true" tabindex="-1"></a>encoded <span class="ot">&lt;-</span> <span class="fu">encoder</span>(encoder_input)</span>
<span id="cb54-218"><a href="#cb54-218" aria-hidden="true" tabindex="-1"></a>decoded <span class="ot">&lt;-</span> <span class="fu">decoder</span>(encoded)</span>
<span id="cb54-219"><a href="#cb54-219" aria-hidden="true" tabindex="-1"></a>autoencoder <span class="ot">&lt;-</span> <span class="fu">keras_model</span>(encoder_input, decoded,</span>
<span id="cb54-220"><a href="#cb54-220" aria-hidden="true" tabindex="-1"></a>                           <span class="at">name =</span> <span class="st">"autoencoder"</span>)</span>
<span id="cb54-221"><a href="#cb54-221" aria-hidden="true" tabindex="-1"></a>autoencoder</span>
<span id="cb54-222"><a href="#cb54-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-223"><a href="#cb54-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-224"><a href="#cb54-224" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fit the model</span></span>
<span id="cb54-225"><a href="#cb54-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-228"><a href="#cb54-228" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-229"><a href="#cb54-229" aria-hidden="true" tabindex="-1"></a>history <span class="ot">&lt;-</span> autoencoder <span class="sc">|&gt;</span></span>
<span id="cb54-230"><a href="#cb54-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compile</span>(<span class="at">loss =</span> <span class="st">"mae"</span>,</span>
<span id="cb54-231"><a href="#cb54-231" aria-hidden="true" tabindex="-1"></a>          <span class="at">optimizer =</span> <span class="st">"adam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-232"><a href="#cb54-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(</span>
<span id="cb54-233"><a href="#cb54-233" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> normal_train_data_x,</span>
<span id="cb54-234"><a href="#cb54-234" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> normal_train_data_x,</span>
<span id="cb54-235"><a href="#cb54-235" aria-hidden="true" tabindex="-1"></a>    <span class="at">epochs =</span> <span class="dv">20</span>,</span>
<span id="cb54-236"><a href="#cb54-236" aria-hidden="true" tabindex="-1"></a>    <span class="at">batch_size =</span> <span class="dv">512</span>,</span>
<span id="cb54-237"><a href="#cb54-237" aria-hidden="true" tabindex="-1"></a>    <span class="at">validation_data =</span> <span class="fu">list</span>(</span>
<span id="cb54-238"><a href="#cb54-238" aria-hidden="true" tabindex="-1"></a>      test_data_x,</span>
<span id="cb54-239"><a href="#cb54-239" aria-hidden="true" tabindex="-1"></a>      test_data_x</span>
<span id="cb54-240"><a href="#cb54-240" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-241"><a href="#cb54-241" aria-hidden="true" tabindex="-1"></a>    <span class="at">shuffle =</span> <span class="cn">TRUE</span></span>
<span id="cb54-242"><a href="#cb54-242" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-243"><a href="#cb54-243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-244"><a href="#cb54-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-247"><a href="#cb54-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-248"><a href="#cb54-248" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(history)</span>
<span id="cb54-249"><a href="#cb54-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-250"><a href="#cb54-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-251"><a href="#cb54-251" aria-hidden="true" tabindex="-1"></a><span class="fu"># Plot the predictions</span></span>
<span id="cb54-252"><a href="#cb54-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-253"><a href="#cb54-253" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reconstruction on Normal data</span></span>
<span id="cb54-254"><a href="#cb54-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-257"><a href="#cb54-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-258"><a href="#cb54-258" aria-hidden="true" tabindex="-1"></a>encoded_data <span class="ot">&lt;-</span> encoder <span class="sc">|&gt;</span></span>
<span id="cb54-259"><a href="#cb54-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(normal_test_data_x)</span>
<span id="cb54-260"><a href="#cb54-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-261"><a href="#cb54-261" aria-hidden="true" tabindex="-1"></a>decoded_data <span class="ot">&lt;-</span> decoder <span class="sc">|&gt;</span> </span>
<span id="cb54-262"><a href="#cb54-262" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(encoded_data)</span>
<span id="cb54-263"><a href="#cb54-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-264"><a href="#cb54-264" aria-hidden="true" tabindex="-1"></a>decoded_data_to_plot <span class="ot">&lt;-</span> decoded_data <span class="sc">|&gt;</span> </span>
<span id="cb54-265"><a href="#cb54-265" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-266"><a href="#cb54-266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-267"><a href="#cb54-267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),<span class="at">values_to =</span> <span class="st">'Reconstruction'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-268"><a href="#cb54-268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> name <span class="sc">|&gt;</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">d+'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>())</span>
<span id="cb54-269"><a href="#cb54-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-270"><a href="#cb54-270" aria-hidden="true" tabindex="-1"></a>normal_test_data_to_plot <span class="ot">&lt;-</span> normal_test_data_x <span class="sc">|&gt;</span></span>
<span id="cb54-271"><a href="#cb54-271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-272"><a href="#cb54-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-273"><a href="#cb54-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),<span class="at">values_to =</span> <span class="st">'Input'</span>)<span class="sc">|&gt;</span> </span>
<span id="cb54-274"><a href="#cb54-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> name <span class="sc">|&gt;</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">d+'</span>)<span class="sc">|&gt;</span> <span class="fu">as.numeric</span>())</span>
<span id="cb54-275"><a href="#cb54-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-276"><a href="#cb54-276" aria-hidden="true" tabindex="-1"></a>data_to_plot <span class="ot">&lt;-</span> decoded_data_to_plot <span class="sc">|&gt;</span> </span>
<span id="cb54-277"><a href="#cb54-277" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(normal_test_data_to_plot,<span class="at">by =</span> <span class="st">'name'</span>)</span>
<span id="cb54-278"><a href="#cb54-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-279"><a href="#cb54-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-280"><a href="#cb54-280" aria-hidden="true" tabindex="-1"></a>data_to_plot <span class="sc">|&gt;</span></span>
<span id="cb54-281"><a href="#cb54-281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>name,<span class="at">names_to =</span> <span class="st">'source'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-282"><a href="#cb54-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> name,<span class="at">y =</span> value,<span class="at">colour =</span> source,<span class="at">group =</span> source)) <span class="sc">+</span> </span>
<span id="cb54-283"><a href="#cb54-283" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb54-284"><a href="#cb54-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb54-285"><a href="#cb54-285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Recontruction on test data'</span>,<span class="at">x =</span> <span class="cn">NULL</span>,<span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb54-286"><a href="#cb54-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-287"><a href="#cb54-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-288"><a href="#cb54-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-289"><a href="#cb54-289" aria-hidden="true" tabindex="-1"></a><span class="fu">## Reconstruction on Anomalous data</span></span>
<span id="cb54-290"><a href="#cb54-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-291"><a href="#cb54-291" aria-hidden="true" tabindex="-1"></a>It is clear that the reconstruction can't quite create the output, this is what we will exploit to define outliers.</span>
<span id="cb54-292"><a href="#cb54-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-295"><a href="#cb54-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-296"><a href="#cb54-296" aria-hidden="true" tabindex="-1"></a>encoded_data <span class="ot">&lt;-</span> encoder <span class="sc">|&gt;</span></span>
<span id="cb54-297"><a href="#cb54-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(anomalous_test_data_x)</span>
<span id="cb54-298"><a href="#cb54-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-299"><a href="#cb54-299" aria-hidden="true" tabindex="-1"></a>decoded_data <span class="ot">&lt;-</span> decoder <span class="sc">|&gt;</span> </span>
<span id="cb54-300"><a href="#cb54-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(encoded_data)</span>
<span id="cb54-301"><a href="#cb54-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-302"><a href="#cb54-302" aria-hidden="true" tabindex="-1"></a>decoded_data_to_plot <span class="ot">&lt;-</span> decoded_data <span class="sc">|&gt;</span> </span>
<span id="cb54-303"><a href="#cb54-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-304"><a href="#cb54-304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-305"><a href="#cb54-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),<span class="at">values_to =</span> <span class="st">'Reconstruction'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-306"><a href="#cb54-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> name <span class="sc">|&gt;</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">d+'</span>) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>())</span>
<span id="cb54-307"><a href="#cb54-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-308"><a href="#cb54-308" aria-hidden="true" tabindex="-1"></a>normal_test_data_to_plot <span class="ot">&lt;-</span> anomalous_test_data_x <span class="sc">|&gt;</span></span>
<span id="cb54-309"><a href="#cb54-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb54-310"><a href="#cb54-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-311"><a href="#cb54-311" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(),<span class="at">values_to =</span> <span class="st">'Input'</span>)<span class="sc">|&gt;</span> </span>
<span id="cb54-312"><a href="#cb54-312" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> name <span class="sc">|&gt;</span> stringr<span class="sc">::</span><span class="fu">str_extract</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">d+'</span>)<span class="sc">|&gt;</span> <span class="fu">as.numeric</span>())</span>
<span id="cb54-313"><a href="#cb54-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-314"><a href="#cb54-314" aria-hidden="true" tabindex="-1"></a>data_to_plot <span class="ot">&lt;-</span> decoded_data_to_plot <span class="sc">|&gt;</span> </span>
<span id="cb54-315"><a href="#cb54-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(normal_test_data_to_plot,<span class="at">by =</span> <span class="st">'name'</span>)</span>
<span id="cb54-316"><a href="#cb54-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-317"><a href="#cb54-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-318"><a href="#cb54-318" aria-hidden="true" tabindex="-1"></a>data_to_plot <span class="sc">|&gt;</span></span>
<span id="cb54-319"><a href="#cb54-319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>name,<span class="at">names_to =</span> <span class="st">'source'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb54-320"><a href="#cb54-320" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> name,<span class="at">y =</span> value,<span class="at">colour =</span> source,<span class="at">group =</span> source)) <span class="sc">+</span> </span>
<span id="cb54-321"><a href="#cb54-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb54-322"><a href="#cb54-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb54-323"><a href="#cb54-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Recontruction on Anomalous test data'</span>,<span class="at">x =</span> <span class="cn">NULL</span>,<span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb54-324"><a href="#cb54-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-325"><a href="#cb54-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-326"><a href="#cb54-326" aria-hidden="true" tabindex="-1"></a><span class="fu"># Detect anomalies</span></span>
<span id="cb54-327"><a href="#cb54-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-328"><a href="#cb54-328" aria-hidden="true" tabindex="-1"></a><span class="fu">## Discover the threshold to flag annomalies</span></span>
<span id="cb54-329"><a href="#cb54-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-332"><a href="#cb54-332" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-333"><a href="#cb54-333" aria-hidden="true" tabindex="-1"></a>reconstructions <span class="ot">&lt;-</span>  autoencoder <span class="sc">|&gt;</span> <span class="fu">predict</span>(normal_train_data_x) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb54-334"><a href="#cb54-334" aria-hidden="true" tabindex="-1"></a>train_data_tibble <span class="ot">&lt;-</span> normal_train_data_x <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb54-335"><a href="#cb54-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-336"><a href="#cb54-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-337"><a href="#cb54-337" aria-hidden="true" tabindex="-1"></a>train_loss <span class="ot">=</span> <span class="fu">loss_mean_squared_error</span>(<span class="fu">as.matrix</span>(reconstructions), <span class="fu">as.matrix</span>(train_data_tibble))</span>
<span id="cb54-338"><a href="#cb54-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-339"><a href="#cb54-339" aria-hidden="true" tabindex="-1"></a>data_loss <span class="ot">&lt;-</span> train_loss <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb54-340"><a href="#cb54-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-341"><a href="#cb54-341" aria-hidden="true" tabindex="-1"></a>data_loss <span class="sc">|&gt;</span> </span>
<span id="cb54-342"><a href="#cb54-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb54-343"><a href="#cb54-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb54-344"><a href="#cb54-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Loss Normal Train Data'</span>,<span class="at">x =</span> <span class="st">'Train Loss'</span>, <span class="at">y =</span> <span class="st">'No of examples'</span>) <span class="sc">+</span></span>
<span id="cb54-345"><a href="#cb54-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb54-346"><a href="#cb54-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-347"><a href="#cb54-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-350"><a href="#cb54-350" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-351"><a href="#cb54-351" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span><span class="fu">mean</span>(train_loss) <span class="sc">+</span> <span class="fu">sd</span>(train_loss)</span>
<span id="cb54-352"><a href="#cb54-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-353"><a href="#cb54-353" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(threshold <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>())</span>
<span id="cb54-354"><a href="#cb54-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-355"><a href="#cb54-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-356"><a href="#cb54-356" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb54-357"><a href="#cb54-357" aria-hidden="true" tabindex="-1"></a><span class="fu">## Completness</span></span>
<span id="cb54-358"><a href="#cb54-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-359"><a href="#cb54-359" aria-hidden="true" tabindex="-1"></a>There are other strategies you could use to select a threshold value above which test examples should be classified as anomalous, the correct approach will depend on your dataset. You can learn more with the links at the end of this tutorial.</span>
<span id="cb54-360"><a href="#cb54-360" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb54-361"><a href="#cb54-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-362"><a href="#cb54-362" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb54-363"><a href="#cb54-363" aria-hidden="true" tabindex="-1"></a><span class="fu">## Strategy</span></span>
<span id="cb54-364"><a href="#cb54-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-365"><a href="#cb54-365" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb54-366"><a href="#cb54-366" aria-hidden="true" tabindex="-1"></a>If you examine the reconstruction error for the anomalous examples in the test set, you'll notice most have greater reconstruction error than the threshold. By varing the threshold, you can adjust the precision and recall of your classifier.</span>
<span id="cb54-367"><a href="#cb54-367" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb54-368"><a href="#cb54-368" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb54-369"><a href="#cb54-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-370"><a href="#cb54-370" aria-hidden="true" tabindex="-1"></a>::: callout-tip</span>
<span id="cb54-371"><a href="#cb54-371" aria-hidden="true" tabindex="-1"></a><span class="fu">## tidy.outliers</span></span>
<span id="cb54-372"><a href="#cb54-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-373"><a href="#cb54-373" aria-hidden="true" tabindex="-1"></a>If you need something faster, and usually more practical do check out my package tidy.outliers for easy to use outlier detection methods.</span>
<span id="cb54-374"><a href="#cb54-374" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb54-375"><a href="#cb54-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-378"><a href="#cb54-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-379"><a href="#cb54-379" aria-hidden="true" tabindex="-1"></a>reconstructions <span class="ot">&lt;-</span>  autoencoder <span class="sc">|&gt;</span> <span class="fu">predict</span>(anomalous_test_data_x) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb54-380"><a href="#cb54-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-381"><a href="#cb54-381" aria-hidden="true" tabindex="-1"></a>anomalous_test_data_x_tibble <span class="ot">&lt;-</span> anomalous_test_data_x <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb54-382"><a href="#cb54-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-383"><a href="#cb54-383" aria-hidden="true" tabindex="-1"></a>test_loss <span class="ot">=</span> <span class="fu">loss_mean_squared_error</span>(<span class="fu">as.matrix</span>(reconstructions), <span class="fu">as.matrix</span>(anomalous_test_data_x_tibble))</span>
<span id="cb54-384"><a href="#cb54-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-385"><a href="#cb54-385" aria-hidden="true" tabindex="-1"></a>data_loss <span class="ot">&lt;-</span> test_loss <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb54-386"><a href="#cb54-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-387"><a href="#cb54-387" aria-hidden="true" tabindex="-1"></a>data_loss <span class="sc">|&gt;</span> </span>
<span id="cb54-388"><a href="#cb54-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb54-389"><a href="#cb54-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">50</span>) <span class="sc">+</span></span>
<span id="cb54-390"><a href="#cb54-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Loss Anomalous Test Data'</span>,<span class="at">x =</span> <span class="st">'Test Loss'</span>, <span class="at">y =</span> <span class="st">'No of examples'</span>) <span class="sc">+</span></span>
<span id="cb54-391"><a href="#cb54-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb54-392"><a href="#cb54-392" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-393"><a href="#cb54-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-394"><a href="#cb54-394" aria-hidden="true" tabindex="-1"></a><span class="fu">## Classify anomalies</span></span>
<span id="cb54-395"><a href="#cb54-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-398"><a href="#cb54-398" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb54-399"><a href="#cb54-399" aria-hidden="true" tabindex="-1"></a>predict_outlier <span class="ot">&lt;-</span> <span class="cf">function</span>(model,data,threshold){</span>
<span id="cb54-400"><a href="#cb54-400" aria-hidden="true" tabindex="-1"></a>  reconstructions <span class="ot">&lt;-</span>  model <span class="sc">|&gt;</span> <span class="fu">predict</span>(data)</span>
<span id="cb54-401"><a href="#cb54-401" aria-hidden="true" tabindex="-1"></a>  loss <span class="ot">&lt;-</span>  <span class="fu">loss_mean_squared_error</span>(reconstructions, data)</span>
<span id="cb54-402"><a href="#cb54-402" aria-hidden="true" tabindex="-1"></a>  df_result <span class="ot">&lt;-</span> keras<span class="sc">::</span><span class="fu">k_less</span>(loss,threshold) <span class="sc">|&gt;</span></span>
<span id="cb54-403"><a href="#cb54-403" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-404"><a href="#cb54-404" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.factor</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-405"><a href="#cb54-405" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span> </span>
<span id="cb54-406"><a href="#cb54-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">estimate =</span> value)</span>
<span id="cb54-407"><a href="#cb54-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df_result)</span>
<span id="cb54-408"><a href="#cb54-408" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-409"><a href="#cb54-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-410"><a href="#cb54-410" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict_outlier</span>(autoencoder,anomalous_test_data_x,threshold)</span>
<span id="cb54-411"><a href="#cb54-411" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> anomalous_test_data <span class="sc">|&gt;</span></span>
<span id="cb54-412"><a href="#cb54-412" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(target_varible) <span class="sc">|&gt;</span> </span>
<span id="cb54-413"><a href="#cb54-413" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">truth =</span> target_varible) <span class="sc">|&gt;</span> </span>
<span id="cb54-414"><a href="#cb54-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">truth =</span> truth <span class="sc">|&gt;</span> <span class="fu">factor</span>(<span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb54-415"><a href="#cb54-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-416"><a href="#cb54-416" aria-hidden="true" tabindex="-1"></a>df_result <span class="ot">&lt;-</span> test_data <span class="sc">|&gt;</span> </span>
<span id="cb54-417"><a href="#cb54-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(preds)</span>
<span id="cb54-418"><a href="#cb54-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-419"><a href="#cb54-419" aria-hidden="true" tabindex="-1"></a>df_result <span class="sc">|&gt;</span> </span>
<span id="cb54-420"><a href="#cb54-420" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">accuracy</span>(<span class="at">truth =</span> truth,<span class="at">estimate =</span> estimate)</span>
<span id="cb54-421"><a href="#cb54-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-422"><a href="#cb54-422" aria-hidden="true" tabindex="-1"></a>df_result <span class="sc">|&gt;</span> </span>
<span id="cb54-423"><a href="#cb54-423" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">precision</span>(<span class="at">truth =</span> truth,<span class="at">estimate =</span> estimate)</span>
<span id="cb54-424"><a href="#cb54-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-425"><a href="#cb54-425" aria-hidden="true" tabindex="-1"></a>df_result <span class="sc">|&gt;</span> </span>
<span id="cb54-426"><a href="#cb54-426" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span><span class="fu">recall</span>(<span class="at">truth =</span> truth,<span class="at">estimate =</span> estimate)</span>
<span id="cb54-427"><a href="#cb54-427" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-428"><a href="#cb54-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-429"><a href="#cb54-429" aria-hidden="true" tabindex="-1"></a><span class="fu"># Changelog</span></span>
<span id="cb54-430"><a href="#cb54-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-431"><a href="#cb54-431" aria-hidden="true" tabindex="-1"></a>2024-02-09 Updated to Keras3.</span>
<span id="cb54-432"><a href="#cb54-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-433"><a href="#cb54-433" aria-hidden="true" tabindex="-1"></a><span class="fu"># Next Steps</span></span>
<span id="cb54-434"><a href="#cb54-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-435"><a href="#cb54-435" aria-hidden="true" tabindex="-1"></a>Check out the <span class="co">[</span><span class="ot">Tensorflow Next Steps</span><span class="co">](https://www.tensorflow.org/tutorials/generative/autoencoder#next_steps "Tensorflow Next Steps")</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This blog is built with ❤️ and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>